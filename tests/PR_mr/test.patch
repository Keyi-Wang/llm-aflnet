*** mr_test.c.orig	2025-11-03 12:40:00.000000000 +0800
--- mr_test.c	2025-11-03 12:45:00.000000000 +0800
***************
*** 1,6 ****
  // mr_test.c
  #define _GNU_SOURCE
  #include "dut.h"
  #include <stdio.h>
  #include <stdlib.h>
  #include <stdint.h>
--- 1,8 ----
  // mr_test.c
  #define _GNU_SOURCE
  #include "dut.h"
  #include <stdio.h>
  #include <stdlib.h>
  #include <stdint.h>
+ #include <libgen.h>
  #include <string.h>
  #include <errno.h>
  #include <sys/stat.h>
  #include <time.h>
  #include <unistd.h>
***************
*** 66,71 ****
--- 68,118 ----
    mkdir(p,0755);
  }
  
+ static void write_bin(const char* path, const uint8_t* buf, size_t len) {
+   FILE* f = fopen(path,"wb"); if (!f) return; fwrite(buf,1,len,f); fclose(f);
+ }
+ 
+ static void write_diff(const char* path,
+                        const uint8_t* A, size_t Al,
+                        const uint8_t* B, size_t Bl) {
+   FILE* f = fopen(path,"w"); if (!f) return;
+   size_t max = (Al > Bl) ? Al : Bl;
+   fprintf(f, "orig_len=%zu reasm_len=%zu\n", Al, Bl);
+   fprintf(f, "OFFSET  A   B\n");
+   for (size_t i = 0; i < max; ++i) {
+     int av = (i < Al) ? A[i] : -1;
+     int bv = (i < Bl) ? B[i] : -1;
+     if (av != bv) {
+       if (av < 0) fprintf(f, "%06zu  --  %02X\n", i, bv & 0xFF);
+       else if (bv < 0) fprintf(f, "%06zu  %02X  --\n", i, av & 0xFF);
+       else fprintf(f, "%06zu  %02X  %02X\n", i, av & 0xFF, bv & 0xFF);
+     }
+     if (i > 100000) { /* 防爆文件，超大只写前 100k 差异 */
+       fprintf(f, "... truncated ...\n"); break;
+     }
+   }
+   fclose(f);
+ }
+ 
+ static long first_diff_1based(const uint8_t* A, size_t Al,
+                               const uint8_t* B, size_t Bl) {
+   size_t max = (Al < Bl) ? Al : Bl;
+   for (size_t i=0;i<max;i++) if (A[i]!=B[i]) return (long)i+1;
+   if (Al!=Bl) return (long)max+1;
+   return -1;
+ }
+ 
  int main(int argc, char **argv) {
    if (argc < 2) {
      fprintf(stderr, "用法: %s <input-file | ->\n", argv[0]);
      return 2;
    }
***************
*** 127,141 ****
    if (ok) {
      fprintf(stderr,"OK %s (len=%zu,msgs=%zu)\n", in_path, orig_len, arr.n);
    } else {
-     fprintf(stderr,"MR_FAIL %s (orig=%zu,reasm=%zu,msgs=%zu)\n", in_path, orig_len, reasm_len, arr.n);
-     if (outdir) {
-       ensure_dir(outdir);
-       char case_dir[512]; snprintf(case_dir,sizeof(case_dir),"%s/%ld-%d", outdir,(long)time(NULL),getpid());
-       ensure_dir(case_dir);
-       char p1[640],p2[640];
-       snprintf(p1,sizeof(p1), "%s/input.bin", case_dir);
-       snprintf(p2,sizeof(p2), "%s/reasm.bin", case_dir);
-       write_bin(p1, orig,  orig_len);
-       write_bin(p2, reasm, reasm_len);
-     }
+     fprintf(stderr,"MR_FAIL %s (orig=%zu,reasm=%zu,msgs=%zu)\n",
+             in_path, orig_len, reasm_len, arr.n);
+     long fdiff = first_diff_1based(A,Al,B,Bl);
+     if (fdiff > 0)
+       fprintf(stderr," first-diff (1-based) = %ld\n", fdiff);
+     if (outdir) {
+       ensure_dir(outdir);
+       char base[256]; strncpy(base, in_path, sizeof(base)-1); base[sizeof(base)-1]=0;
+       char *bn = basename(base);
+       char case_dir[640];
+       snprintf(case_dir,sizeof(case_dir),"%s/%s-%ld-%d", outdir, bn, (long)time(NULL), getpid());
+       ensure_dir(case_dir);
+       char p1[768],p2[768],p3[768];
+       snprintf(p1,sizeof(p1), "%s/input.bin", case_dir);
+       snprintf(p2,sizeof(p2), "%s/reasm.bin", case_dir);
+       snprintf(p3,sizeof(p3), "%s/diff.txt",  case_dir);
+       write_bin(p1, orig,  orig_len);
+       write_bin(p2, reasm, reasm_len);
+       write_diff(p3, A, Al, B, Bl);
+       fprintf(stderr," saved: %s\n", case_dir);
+     }
    }
